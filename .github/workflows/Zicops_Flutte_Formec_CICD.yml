name: Zicops Flutter CI-CD<>Formec

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  JAVA_HOME: /opt/hostedtoolcache/jdk/11.0.11/x64

jobs:
  flutter_test:
    name: Run flutter test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v1
        with:
          java-version: "11.x"
      - uses: subosito/flutter-action@v2
        with:
          channel: "beta"
      - run: flutter pub get
      # - run: flutter analyze
      - run: flutter test

  build_ios:
    name: Build Flutter (iOS)
    needs: [flutter_test]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v1
        with:
          java-version: "11.x"
      - uses: subosito/flutter-action@v2
        with:
          channel: "beta"
      - run: flutter pub get
      - run: flutter clean
      - name: Cache dependencies
        id: cache-dependencies
        uses: actions/cache@v2
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-ios-${{ hashFiles('**/pubspec.lock') }}
      - run: flutter build ios --release --no-codesign
      - name: Cache outputs of build step
        uses: actions/cache@v2
        with:
          path: build/ios/iphoneos
          key: apple-${{ github.sha }}

  build_appbundle:
    name: Build Flutter (Android)
    needs: [flutter_test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v1
        with:
          java-version: "11.x"
      - uses: subosito/flutter-action@v2
        with:
          channel: "beta"
      - name: Cache pub packages
        uses: actions/cache@v2
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-android-${{ hashFiles('**/pubspec.lock') }}
      - run: flutter pub get
      - run: flutter clean
      - run: flutter build appbundle --release
      - name: Cache outputs of build step
        uses: actions/cache@v2
        with:
          path: build/app/outputs/apk/release
          key: android-${{ github.sha }}

  upload_apps_artifacts:
    name: Upload Zicops Flutter Bundles
    needs: [build_appbundle, build_ios]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Get the apk file from cache
        uses: actions/cache@v2
        with:
          path: build/app/outputs/apk/release
          key: android-${{ github.sha }}
      - name: Get the ipa file from cache
        uses: actions/cache@v2
        with:
          path: build/ios/iphoneos
          key: apple-${{ github.sha }}
      - name: Upload Android bundle
        uses: actions/upload-artifact@v2
